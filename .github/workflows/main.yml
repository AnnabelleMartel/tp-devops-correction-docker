# Nom du workflow affiché dans l'interface GitHub Actions
name: CI devops 2025

# Déclencheurs du workflow
on:
  # Déclenchement lors d'un push sur la branche main
  push:
    branches: 
      - main
  # Déclenchement lors d'une pull request vers n'importe quelle branche
  pull_request:

# Définition des jobs à exécuter
jobs:
  # Nom du job : test-backend
  test-backend: 
    # Système d’exploitation utilisé pour exécuter le job
    runs-on: ubuntu-24.04

    steps:
      # Étape 1 : Cloner le code du dépôt dans le runner GitHub
      - uses: actions/checkout@v4

      # Étape 2 : Installer et configurer Java JDK 21 avec la distribution Temurin
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'           # Version du JDK
          distribution: 'temurin'      # Distribution du JDK (Temurin est une distribution open-source)

      # Étape 3 : Nettoyer, compiler et tester le projet avec Maven
      - name: Build and test with Maven
        run: mvn clean verify --file ./simple-api/pom.xml
        # 'clean' supprime les fichiers précédemment compilés
        # 'verify' compile, exécute les tests et vérifie la validité du projet
        # '--file' précise le chemin du fichier pom.xml pour cibler le bon sous-module

  # define job to build and publish docker image
build-and-push-docker-image:
 needs: test-backend
 # run only when code is compiling and tests are passing
 runs-on: ubuntu-24.04

 # steps to perform in job
 steps:
   - name: Checkout code
     uses: actions/checkout@v4

   - name: Build image and push backend
     uses: docker/build-push-action@v6
     with:
          context: ./simple-api
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-simple-api:latest
          push: ${{ github.ref == 'refs/heads/main' }}

   - name: Build image and push database
     uses: docker/build-push-action@v6
     with:
        context: ./database
        tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-database:latest
        push: ${{ github.ref == 'refs/heads/main' }}

   - name: Build image and push httpd
     uses: docker/build-push-action@v6
     with:
          context: ./httpd
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tp-devops-httpd:latest
          push: ${{ github.ref == 'refs/heads/main' }}
